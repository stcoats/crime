<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Forensic DB</title>
  <link 
    rel="stylesheet" 
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css"
    crossorigin="anonymous"
  >
  <style>
    body { margin: 16px; font-size: 0.9rem; }
    th { cursor: pointer; }
    .audio-cell audio { width: 160px; }
    .sort-indicator { font-size: 0.7rem; color: #999; margin-left: 4px; }
  </style>
</head>
<body class="container">
  <div class="d-flex justify-content-between align-items-end mb-3">
    <h1 class="h3">C.R.I.M.E. DB Results</h1>
    <small class="text-muted text-end" style="max-width: 60%;">
      This database contains transcript segments with associated audio from the <i>Corpus of Investigative Interviews and Criminal Justice Discourse</i>. Please wait a few moments for the database to load. You can search by text or POS tags, sort by any column, and play the corresponding audio URL.
    </small>
  </div>

  <div class="row mb-3">
    <div class="col-auto">
      <label for="searchInput" class="form-label">Search text:</label>
      <input type="text" id="searchInput" class="form-control" placeholder='Search text or POS tags'>
    </div>
    <div class="col-auto align-self-end">
      <button class="btn btn-primary" onclick="doSearch()">Search</button>
    </div>
  </div>
  <div class="mb-2 text-muted" id="hitCount">Loading results...</div>

  <table class="table table-bordered table-striped table-hover table-sm" id="dataTable">
    <thead class="table-dark">
      <tr>
        <th onclick="sortBy('id')">ID<span class="sort-indicator">▴▾</span></th>
        <th onclick="sortBy('playlist')">Playlist<span class="sort-indicator">▴▾</span></th>
        <th onclick="sortBy('title')">Title<span class="sort-indicator">▴▾</span></th>
        <th onclick="sortBy('timing')">Timing<span class="sort-indicator">▴▾</span></th>
        <th>Audio</th>
        <th onclick="sortBy('transcript')">Transcript<span class="sort-indicator">▴▾</span></th>
        <th onclick="sortBy('pos_tags')">POS<span class="sort-indicator">▴▾</span></th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <div class="d-flex justify-content-center my-3" id="paginationControls"></div>

  <script>
let currentPage = 1;
let totalRows = 0;
let pageSize = 100;
let currentSort = 'ID';
let currentDirection = 'asc';

function doSearch() {
  currentPage = 1;
  loadData();
}

function sortBy(column) {
  if (currentSort === column) {
    currentDirection = (currentDirection === 'asc') ? 'desc' : 'asc';
  } else {
    currentSort = column;
    currentDirection = 'asc';
  }
  currentPage = 1;
  loadData();
}

function goPage(page) {
  if (page < 1) return;
  const totalPages = Math.ceil(totalRows / pageSize);
  if (page > totalPages) return;
  currentPage = page;
  loadData();
}

function highlightMatches(text, query) {
  if (!query || !text) return text;
  const quoted = /^["'].*["']$/.test(query);
  const cleanQuery = query.replace(/^["']|["']$/g, '');
  if (quoted) {
    const phrase = cleanQuery.replace(/[-/\\^$*+?.()|[\]{}]/g, '\\$&');
    const pattern = new RegExp(phrase, 'gi');
    return text.replace(pattern, match =>
      `<span style="color:red; font-weight:bold;">${match}</span>`
    );
  } else {
    const words = cleanQuery.split(/\s+/).filter(Boolean);
    if (words.length === 0) return text;
    const pattern = new RegExp(`\\b(${words.map(w => w.replace(/[-/\\^$*+?.()|[\]{}]/g, '\\$&')).join('|')})\\b`, 'gi');
    return text.replace(pattern, match =>
      `<span style="color:red; font-weight:bold;">${match}</span>`
    );
  }
}

function loadData() {
  const inputEl = document.getElementById('searchInput');
  if (!inputEl) return;
  const textVal = inputEl.value.trim();
  const url = `/data?page=${currentPage}&size=${pageSize}&text=${encodeURIComponent(textVal)}&sort=${currentSort}&direction=${currentDirection}`;

  fetch(url)
    .then(res => res.json())
    .then(json => {
      totalRows = json.total;
      renderTable(json.data, textVal);
      renderPagination();
      renderHitCount();
    })
    .catch(err => console.error("Error fetching /data:", err));
}

function renderTable(rows, queryText) {
  const tbody = document.querySelector("#dataTable tbody");
  tbody.innerHTML = "";

  rows.forEach(r => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${r.ID}</td>
      <td>${r.playlist}</td>
      <td>${r.title}</td>
      <td>${r.timing || ""}</td>
      <td class="audio-cell">
        <audio controls preload="none">
          <source src="${r.audio}" type="audio/mpeg">
        </audio>
      </td>
      <td>${highlightMatches(r.transcript, queryText)}</td>
      <td>${highlightMatches(r.pos_tags, queryText)}</td>
    `;
    tbody.appendChild(tr);
  });
}

function renderPagination() {
  const container = document.getElementById("paginationControls");
  container.innerHTML = "";
  const totalPages = Math.ceil(totalRows / pageSize);
  if (totalPages <= 1) return;

  const makeBtn = (label, targetPage) => {
    const btn = document.createElement("button");
    btn.classList.add("btn", "btn-sm", "btn-secondary", "mx-1");
    btn.textContent = label;
    btn.onclick = () => goPage(targetPage);
    return btn;
  };

  if (currentPage > 1) {
    container.appendChild(makeBtn("« First", 1));
    container.appendChild(makeBtn("‹ Prev", currentPage - 1));
  }

  const info = document.createElement("span");
  info.classList.add("mx-3", "align-self-center");
  info.textContent = `Page ${currentPage} of ${totalPages}`;
  container.appendChild(info);

  if (currentPage < totalPages) {
    container.appendChild(makeBtn("Next ›", currentPage + 1));
    container.appendChild(makeBtn("Last »", totalPages));
  }
}

function renderHitCount() {
  const counter = document.getElementById("hitCount");
  counter.textContent = `${totalRows} results found.`;
}

window.addEventListener("DOMContentLoaded", () => {
  loadData();
  document.getElementById('searchInput').addEventListener('keydown', e => {
    if (e.key === 'Enter') doSearch();
  });
});
</script>

</body>
</html>
