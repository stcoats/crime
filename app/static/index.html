<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Forensic DB</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" crossorigin="anonymous">
  <style>
    body { margin: 16px; font-size: 0.9rem; }
    th { cursor: pointer; }
    .audio-cell audio { width: 160px; }
    .sort-indicator { font-size: 0.7rem; color: #999; margin-left: 4px; }
  </style>
</head>
<body class="container">
  <div class="d-flex justify-content-between align-items-end mb-3">
    <h1 class="h3">C.R.I.M.E. DB Results</h1>
    <small class="text-muted text-end" style="max-width: 60%;">
      This database contains transcript segments with associated audio from the <i>Corpus of Investigative Interviews and Criminal Justice Discourse</i>.
      Please wait a few moments for the database to load. You can search by transcript text (e.g. <code>court ruled</code>) or POS tags (e.g. <code>NN VBD</code>).
      To search for an exact phrase, use quotes (e.g. <code>"did you say"</code>). The "timing" column indicates the offset time, in seconds, from the start of the corresponding video.
    </small>
  </div>

  <div class="row mb-3">
    <div class="col-auto">
      <label for="searchInput" class="form-label">Search text:</label>
      <input type="text" id="searchInput" class="form-control" placeholder="Search text or POS tags">
    </div>
    <div class="col-auto align-self-end">
      <button class="btn btn-primary" onclick="doSearch()">Search</button>
    </div>
  </div>

  <div class="mb-2"><strong>Filter by Playlist:</strong></div>
  <div class="mb-3" id="playlistFilters" style="margin-bottom: 10px;"></div>

  <div class="mb-2 text-muted" id="hitCount">Loading results...</div>

  <table class="table table-bordered table-striped table-hover table-sm" id="dataTable">
    <thead class="table-dark">
      <tr>
        <th onclick="sortBy('id')">ID<span class="sort-indicator">▴▾</span></th>
        <th onclick="sortBy('playlist')">Playlist<span class="sort-indicator">▴▾</span></th>
        <th onclick="sortBy('title')">Title<span class="sort-indicator">▴▾</span></th>
        <th onclick="sortBy('timing')">Timing<span class="sort-indicator">▴▾</span></th>
        <th>Audio</th>
        <th onclick="sortBy('transcript')">Transcript<span class="sort-indicator">▴▾</span></th>
        <th onclick="sortBy('pos_tags')">POS<span class="sort-indicator">▴▾</span></th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <div class="d-flex justify-content-center my-3" id="paginationControls"></div>

<script>
let currentPage = 1;
let totalRows = 0;
let pageSize = 100;
let currentSort = 'id';
let currentDirection = 'asc';

function extractTokens(query) {
  const cleaned = query.replace(/^["']|["']$/g, '');
  return cleaned.split(/\s+/).filter(Boolean);
}

function highlightMatches(text, tokens) {
  if (!text || tokens.length === 0) return text;
  const pattern = new RegExp(`\\b(${tokens.map(t => t.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&')).join('|')})\\b`, 'gi');
  return text.replace(pattern, match => `<span style="color:red; font-weight:bold;">${match}</span>`);
}

function doSearch() {
  currentPage = 1;
  loadData();
}

function sortBy(column) {
  if (currentSort === column) {
    currentDirection = (currentDirection === 'asc') ? 'desc' : 'asc';
  } else {
    currentSort = column;
    currentDirection = 'asc';
  }
  currentPage = 1;
  loadData();
}

function goPage(page) {
  if (page < 1) return;
  const totalPages = Math.ceil(totalRows / pageSize);
  if (page > totalPages) return;
  currentPage = page;
  loadData();
}

function loadPlaylists() {
  fetch('/playlists')
    .then(res => res.json())
    .then(list => {
      const container = document.getElementById('playlistFilters');
      container.innerHTML = "";
      list.forEach(playlist => {
        const safeId = `playlist_${playlist.replace(/\W+/g, '_')}`;
        const wrapper = document.createElement('div');
        wrapper.classList.add('form-check', 'form-check-inline');
        wrapper.innerHTML = `
          <input class="form-check-input" type="checkbox" id="${safeId}" value="${playlist}" checked>
          <label class="form-check-label" for="${safeId}">${playlist}</label>
        `;
        container.appendChild(wrapper);
      });
    })
    .catch(err => {
      console.error("Failed to load playlists:", err);
    });
}

function loadData() {
  const inputEl = document.getElementById('searchInput');
  if (!inputEl) return;
  const textVal = inputEl.value.trim();
  const tokens = extractTokens(textVal);

  const selectedPlaylists = Array.from(
    document.querySelectorAll('#playlistFilters input[type=checkbox]:checked')
  ).map(cb => cb.value);

  const params = new URLSearchParams({
    page: currentPage,
    size: pageSize,
    text: textVal,
    sort: currentSort,
    direction: currentDirection
  });

  selectedPlaylists.forEach(p => params.append("playlist", p));

  fetch('/data?' + params.toString())
    .then(res => res.json())
    .then(json => {
      totalRows = json.total;
      renderTable(json.data, tokens);
      renderPagination();
      renderHitCount();
    })
    .catch(err => console.error("Error fetching /data:", err));
}

function renderTable(rows, tokens) {
  const tbody = document.querySelector("#dataTable tbody");
  tbody.innerHTML = "";

  const isPOS = tokens.every(t => /^[A-Z$]+$/.test(t));
  rows.forEach(r => {
    const words = (r.transcript || "").split(/\s+/);
    const tags = (r.pos_tags || "").split(/\s+/);
    let highlightedWords = [], highlightedTags = [];

    if (isPOS) {
      highlightedTags = tags.map((tag, i) =>
        tokens.includes(tag) ? `<span style="color:red; font-weight:bold;">${tag}</span>` : tag
      );
      highlightedWords = words.map((w, i) =>
        tokens.includes(tags[i]) ? `<span style="color:red; font-weight:bold;">${w}</span>` : w
      );
    } else {
      highlightedWords = words.map(w =>
        tokens.includes(w.toLowerCase()) ? `<span style="color:red; font-weight:bold;">${w}</span>` : w
      );
      highlightedTags = tags.map((tag, i) =>
        tokens.includes((words[i] || "").toLowerCase()) ? `<span style="color:red; font-weight:bold;">${tag}</span>` : tag
      );
    }

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${r.id}</td>
      <td>${r.playlist}</td>
      <td>${r.title}</td>
      <td>${r.timing || ""}</td>
      <td class="audio-cell"><audio controls preload="none"><source src="${r.audio}" type="audio/mpeg"></audio></td>
      <td>${highlightedWords.join(" ")}</td>
      <td>${highlightedTags.join(" ")}</td>
    `;
    tbody.appendChild(tr);
  });
}

function renderPagination() {
  const container = document.getElementById("paginationControls");
  container.innerHTML = "";
  const totalPages = Math.ceil(totalRows / pageSize);
  if (totalPages <= 1) return;

  const makeBtn = (label, targetPage) => {
    const btn = document.createElement("button");
    btn.classList.add("btn", "btn-sm", "btn-secondary", "mx-1");
    btn.textContent = label;
    btn.onclick = () => goPage(targetPage);
    return btn;
  };

  if (currentPage > 1) {
    container.appendChild(makeBtn("« First", 1));
    container.appendChild(makeBtn("‹ Prev", currentPage - 1));
  }

  const info = document.createElement("span");
  info.classList.add("mx-3", "align-self-center");
  info.textContent = `Page ${currentPage} of ${totalPages}`;
  container.appendChild(info);

  if (currentPage < totalPages) {
    container.appendChild(makeBtn("Next ›", currentPage + 1));
    container.appendChild(makeBtn("Last »", totalPages));
  }
}

function renderHitCount() {
  const counter = document.getElementById("hitCount");
  counter.textContent = `${totalRows} results found.`;
}

window.addEventListener("DOMContentLoaded", () => {
  loadPlaylists();
  loadData();
  document.getElementById('searchInput').addEventListener('keydown', e => {
    if (e.key === 'Enter') doSearch();
  });
});
</script>

</body>
</html>
