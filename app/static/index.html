<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>YCSEP DB Results</title>
  <!-- Bootstrap CSS from a CDN -->
  <link 
    rel="stylesheet" 
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css">

  <style>
    /* Additional custom styles if needed */
    body {
      margin: 16px;
    }
    th {
      cursor: pointer;
    }
    .audio-cell audio {
      width: 180px;
    }
  </style>
</head>
<body class="container">
  <h1 class="mt-4">YCSEP DB Results</h1>

  <div class="row my-3">
    <div class="col-auto">
      <label for="searchInput" class="form-label">Search text:</label>
      <input type="text" id="searchInput" class="form-control" placeholder="e.g. can can">
    </div>
    <div class="col-auto align-self-end">
      <button class="btn btn-primary" onclick="doSearch()">Search</button>
    </div>
  </div>

  <table class="table table-bordered table-striped" id="dataTable">
    <thead>
      <tr>
        <th onclick="sortBy('id')">ID</th>
        <th onclick="sortBy('channel')">Channel</th>
        <th onclick="sortBy('video_id')">Video ID</th>
        <th onclick="sortBy('speaker')">Speaker</th>
        <th onclick="sortBy('start_time')">Start</th>
        <th onclick="sortBy('end_time')">End</th>
        <th>Audio</th>
        <th onclick="sortBy('text')">Text</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <div class="d-flex justify-content-center my-3" id="paginationControls"></div>

  <script>
    let currentPage = 1;
    let totalRows = 0;
    let pageSize = 100;
    let currentSort = 'id';
    let currentDirection = 'asc';

    function doSearch() {
      currentPage = 1;
      loadData();
    }

    function sortBy(column) {
      if (currentSort === column) {
        currentDirection = (currentDirection === 'asc') ? 'desc' : 'asc';
      } else {
        currentSort = column;
        currentDirection = 'asc';
      }
      currentPage = 1;
      loadData();
    }

    function goPage(page) {
      currentPage = page;
      loadData();
    }

    function loadData() {
      const textVal = document.getElementById('searchInput').value.trim();
      const url = `/data?page=${currentPage}&size=${pageSize}&text=${encodeURIComponent(textVal)}&sort=${currentSort}&direction=${currentDirection}`;

      fetch(url)
        .then(res => res.json())
        .then(json => {
          totalRows = json.total;
          renderTable(json.data);
          renderPagination();
        })
        .catch(err => {
          console.error("Error fetching /data:", err);
        });
    }

    function renderTable(rows) {
      const tbody = document.querySelector("#dataTable tbody");
      tbody.innerHTML = "";

      rows.forEach(r => {
        const tr = document.createElement("tr");
        // Build audio column from r.id
        // If your DB uses int, do parseInt or string, etc.
        const audioUrl = `/audio/${encodeURIComponent(r.id)}`;

        tr.innerHTML = `
          <td>${r.id}</td>
          <td>${r.channel}</td>
          <td>${r.video_id}</td>
          <td>${r.speaker}</td>
          <td>${r.start_time}</td>
          <td>${r.end_time}</td>
          <td class="audio-cell">
            <audio controls preload="none">
              <source src="${audioUrl}" type="audio/mpeg">
            </audio>
          </td>
          <td>${r.text}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    function renderPagination() {
      const container = document.getElementById("paginationControls");
      container.innerHTML = "";
      const totalPages = Math.ceil(totalRows / pageSize);

      if (currentPage > 1) {
        const btnPrev = document.createElement("button");
        btnPrev.classList.add("btn","btn-secondary","me-2");
        btnPrev.textContent = "Prev";
        btnPrev.onclick = () => goPage(currentPage - 1);
        container.appendChild(btnPrev);
      }

      const pageInfo = document.createElement("span");
      pageInfo.classList.add("align-self-center","mx-2");
      pageInfo.textContent = `Page ${currentPage} of ${totalPages}`;
      container.appendChild(pageInfo);

      if (currentPage < totalPages) {
        const btnNext = document.createElement("button");
        btnNext.classList.add("btn","btn-secondary","ms-2");
        btnNext.textContent = "Next";
        btnNext.onclick = () => goPage(currentPage + 1);
        container.appendChild(btnNext);
      }
    }

    // Initial load
    loadData();
  </script>
</body>
</html>
