<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Forensic DB</title>
  <link 
    rel="stylesheet" 
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css"
    crossorigin="anonymous"
  >
  <style>
    body { margin: 16px; font-size: 0.9rem; }
    th { cursor: pointer; }
    .audio-cell audio { width: 160px; }
    .sort-indicator { font-size: 0.7rem; color: #999; margin-left: 4px; }
  </style>
</head>
<body class="container">
  <div class="d-flex justify-content-between align-items-end mb-3">
    <h1 class="h3">C.R.I.M.E. DB Results</h1>
    <small class="text-muted text-end" style="max-width: 60%;">
      This database contains transcript segments with associated audio from the Corpus of Investigative Interviews and Criminal Justice Discourse. You can search by text or POS tags, sort by any column, and play the corresponding audio URL.
    </small>
  </div>

  <div class="row mb-3">
    <div class="col-auto">
      <label for="searchInput" class="form-label">Search text:</label>
      <input type="text" id="searchInput" class="form-control" placeholder='Search text or POS tags'>
    </div>
    <div class="col-auto align-self-end">
      <button class="btn btn-primary" onclick="doSearch()">Search</button>
    </div>
  </div>

  <table class="table table-bordered table-striped table-hover table-sm" id="dataTable">
    <thead class="table-dark">
      <tr>
        <th onclick="sortBy('id')">ID<span class="sort-indicator">▴▾</span></th>
        <th onclick="sortBy('playlist')">Playlist<span class="sort-indicator">▴▾</span></th>
        <th onclick="sortBy('title')">Title<span class="sort-indicator">▴▾</span></th>
        <th onclick="sortBy('timing')">Timing<span class="sort-indicator">▴▾</span></th>
        <th>Audio</th>
        <th onclick="sortBy('transcript')">Transcript<span class="sort-indicator">▴▾</span></th>
        <th onclick="sortBy('pos_tags')">POS<span class="sort-indicator">▴▾</span></th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <div class="d-flex justify-content-center my-3" id="paginationControls"></div>

  <script>
    let currentPage = 1;
    let totalRows = 0;
    let pageSize = 100;
    let currentSort = 'id';
    let currentDirection = 'asc';

    function doSearch() {
      currentPage = 1;
      loadData();
    }

    function sortBy(column) {
      if (currentSort === column) {
        currentDirection = (currentDirection === 'asc') ? 'desc' : 'asc';
      } else {
        currentSort = column;
        currentDirection = 'asc';
      }
      currentPage = 1;
      loadData();
    }

    function goPage(page) {
      currentPage = page;
      loadData();
    }

    function loadData() {
      const inputEl = document.getElementById('searchInput');
      if (!inputEl) return;
      const textVal = inputEl.value.trim();
      const url = `/data?page=${currentPage}&size=${pageSize}&text=${encodeURIComponent(textVal)}&sort=${currentSort}&direction=${currentDirection}`;

      fetch(url)
        .then(res => res.json())
        .then(json => {
          totalRows = json.total;
          renderTable(json.data);
          renderPagination();
        })
        .catch(err => console.error("Error fetching /data:", err));
    }
    function highlightMatches(text, query) {
        if (!query) return text;
      
        // Remove outer quotes from search (optional, only if you want this behavior)
        query = query.replace(/^["']|["']$/g, '');
      
        const escaped = query.replace(/[-/\\^$*+?.()|[\]{}]/g, '\\$&');
        const pattern = new RegExp(escaped, "gi");
      
        return text.replace(pattern, match => `<span style="color:red; font-weight:bold;">${match}</span>`);
      }

    function renderTable(rows) {
      const tbody = document.querySelector("#dataTable tbody");
      tbody.innerHTML = "";
      const inputText = document.getElementById("searchInput").value.trim();
    
      rows.forEach(r => {
        const highlightedTranscript = highlightMatches(r.transcript, inputText);
    
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${r.ID}</td>
          <td>${r.playlist}</td>
          <td>${r.title}</td>
          <td>${r.timing || ""}</td>
          <td class="audio-cell">
            <audio controls preload="none">
              <source src="${r.audio}" type="audio/mpeg">
            </audio>
          </td>
          <td>${highlightedTranscript}</td>
          <td>${r.pos_tags || ""}</td>
        `;
        tbody.appendChild(tr);
      });
    }


    function renderPagination() {
      const container = document.getElementById("paginationControls");
      container.innerHTML = "";
      const totalPages = Math.ceil(totalRows / pageSize);

      if (currentPage > 1) {
        const btnPrev = document.createElement("button");
        btnPrev.classList.add("btn", "btn-secondary", "me-2");
        btnPrev.textContent = "Prev";
        btnPrev.onclick = () => goPage(currentPage - 1);
        container.appendChild(btnPrev);
      }

      const pageInfo = document.createElement("span");
      pageInfo.classList.add("align-self-center", "mx-2");
      pageInfo.textContent = `Page ${currentPage} of ${totalPages}`;
      container.appendChild(pageInfo);

      if (currentPage < totalPages) {
        const btnNext = document.createElement("button");
        btnNext.classList.add("btn", "btn-secondary", "ms-2");
        btnNext.textContent = "Next";
        btnNext.onclick = () => goPage(currentPage + 1);
        container.appendChild(btnNext);
      }
    }

    window.addEventListener("DOMContentLoaded", () => {
      loadData();
    });
  </script>
</body>
</html>
