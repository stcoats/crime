<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>YCSEP DB Results</title>
  <link 
    rel="stylesheet" 
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css"
    crossorigin="anonymous"
  >
  <style>
    body { margin: 16px; font-size: 0.9rem; }
    th { cursor: pointer; }
    .audio-cell audio { width: 160px; }
  </style>
</head>
<body class="container">
<div class="d-flex justify-content-between align-items-end mb-3">
  <h1 class="h3">YCSEP DB Results</h1>
  <small class="text-muted text-end" style="max-width: 60%;">
    This database contains segments from YCSEP. You can search by text or POS tags, sort by any column, and play corresponding audio. Exact phrases can be matched with quotation marks.
  </small>
</div>

<table class="table table-bordered table-striped table-hover table-sm" id="dataTable">
  <thead class="table-dark">
    <tr>
      <th onclick="sortTable('id')">ID ▲▼</th>
      <th onclick="sortTable('channel')">Channel ▲▼</th>
      <th onclick="sortTable('video_id')">Video ID ▲▼</th>
      <th onclick="sortTable('speaker')">Speaker ▲▼</th>
      <th onclick="sortTable('start_time')">Start ▲▼</th>
      <th onclick="sortTable('end_time')">End ▲▼</th>
      <th>Audio</th>
      <th onclick="sortTable('text')">Text ▲▼</th>
      <th onclick="sortTable('pos_tags')">POS ▲▼</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>


  <div class="d-flex justify-content-center my-3" id="paginationControls"></div>

  <script>
    let currentPage = 1;
    let totalRows = 0;
    let pageSize = 100;
    let currentSort = 'id';
    let currentDirection = 'asc';

    function doSearch() {
      currentPage = 1;
      loadData();
    }

    function sortBy(column) {
      if (currentSort === column) {
        currentDirection = (currentDirection === 'asc') ? 'desc' : 'asc';
      } else {
        currentSort = column;
        currentDirection = 'asc';
      }
      currentPage = 1;
      loadData();
    }

    function goPage(page) {
      currentPage = page;
      loadData();
    }

    function loadData() {
      const textVal = document.getElementById('searchInput').value.trim();
      const url = `/data?page=${currentPage}&size=${pageSize}&text=${encodeURIComponent(textVal)}&sort=${currentSort}&direction=${currentDirection}`;

      fetch(url)
        .then(res => res.json())
        .then(json => {
          totalRows = json.total;
          renderTable(json.data);
          renderPagination();
        })
        .catch(err => console.error("Error fetching /data:", err));
    }

    function renderTable(rows) {
      const tbody = document.querySelector("#dataTable tbody");
      tbody.innerHTML = "";

      rows.forEach(r => {
        const audioUrl = `/audio/${encodeURIComponent(r.id)}`;
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${r.id}</td>
          <td>${r.channel}</td>
          <td>${r.video_id}</td>
          <td>${r.speaker}</td>
          <td>${r.start_time}</td>
          <td>${r.end_time}</td>
          <td>${r.pos_tags || ""}</td>
          <td class="audio-cell">
            <audio controls preload="none">
              <source src="${audioUrl}" type="audio/mpeg">
            </audio>
          </td>
          <td>${r.text}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    function renderPagination() {
      const container = document.getElementById("paginationControls");
      container.innerHTML = "";
      const totalPages = Math.ceil(totalRows / pageSize);

      if (currentPage > 1) {
        const btnPrev = document.createElement("button");
        btnPrev.classList.add("btn","btn-secondary","me-2");
        btnPrev.textContent = "Prev";
        btnPrev.onclick = () => goPage(currentPage - 1);
        container.appendChild(btnPrev);
      }

      const pageInfo = document.createElement("span");
      pageInfo.classList.add("align-self-center","mx-2");
      pageInfo.textContent = `Page ${currentPage} of ${totalPages}`;
      container.appendChild(pageInfo);

      if (currentPage < totalPages) {
        const btnNext = document.createElement("button");
        btnNext.classList.add("btn","btn-secondary","ms-2");
        btnNext.textContent = "Next";
        btnNext.onclick = () => goPage(currentPage + 1);
        container.appendChild(btnNext);
      }
    }

    // initial load
    loadData();
  </script>
</body>
</html>
