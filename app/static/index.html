<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>YCSEP Dataset Viewer</title>
  <style>
    body { font-family: sans-serif; margin: 20px; }
    table { border-collapse: collapse; width: 100%; }
    th, td { border: 1px solid #ccc; padding: 6px; text-align: left; }
    th { cursor: pointer; background-color: #f0f0f0; }
    audio { width: 100px; }
    #pagination { margin-top: 20px; }
    #pagination button { margin-right: 5px; }
  </style>
</head>
<body>

<h1>YCSEP Dataset Viewer</h1>

<input type="text" id="searchBox" placeholder="Search text..." style="width: 300px;">
<button onclick="search()">Search</button>

<table id="dataTable">
  <thead>
    <tr>
      <th onclick="sortTable('id')">ID</th>
      <th onclick="sortTable('channel')">Channel</th>
      <th onclick="sortTable('video_id')">Video ID</th>
      <th onclick="sortTable('speaker')">Speaker</th>
      <th onclick="sortTable('start_time')">Start</th>
      <th onclick="sortTable('end_time')">End</th>
      <th onclick="sortTable('upload_date')">Date</th>
      <th onclick="sortTable('text')">Text</th>
      <th>Audio</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<div id="pagination"></div>

<script>
let fullData = [];
let currentPage = 1;
const rowsPerPage = 50;
let currentSort = { key: null, asc: true };

async function fetchData() {
  const response = await fetch('/data');
  fullData = await response.json();
  renderTable();
  renderPagination();
}

function renderTable() {
  const tbody = document.querySelector('#dataTable tbody');
  tbody.innerHTML = '';
  let pageData = paginate(fullData, currentPage, rowsPerPage);
  pageData.forEach(row => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${row.id}</td>
      <td>${row.channel}</td>
      <td>${row.video_id}</td>
      <td>${row.speaker}</td>
      <td>${row.start_time}</td>
      <td>${row.end_time}</td>
      <td>${row.upload_date}</td>
      <td>${row.text}</td>
      <td><audio controls src="/audio/${row.id}"></audio></td>
    `;
    tbody.appendChild(tr);
  });
}

function paginate(data, page, size) {
  const start = (page - 1) * size;
  return data.slice(start, start + size);
}

function renderPagination() {
  const pages = Math.ceil(fullData.length / rowsPerPage);
  const div = document.getElementById('pagination');
  div.innerHTML = '';
  for (let i = 1; i <= pages; i++) {
    const btn = document.createElement('button');
    btn.textContent = i;
    btn.onclick = () => { currentPage = i; renderTable(); };
    if (i === currentPage) btn.style.fontWeight = 'bold';
    div.appendChild(btn);
  }
}

function sortTable(key) {
  if (currentSort.key === key) currentSort.asc = !currentSort.asc;
  else { currentSort.key = key; currentSort.asc = true; }

  fullData.sort((a, b) => {
    if (a[key] < b[key]) return currentSort.asc ? -1 : 1;
    if (a[key] > b[key]) return currentSort.asc ? 1 : -1;
    return 0;
  });
  renderTable();
}

function search() {
  const q = document.getElementById('searchBox').value.trim();
  if (!q) return fetchData();
  fetch(`/search?text=${encodeURIComponent(q)}`)
    .then(res => res.json())
    .then(data => {
      fullData = data;
      currentPage = 1;
      renderTable();
      renderPagination();
    });
}

fetchData();
</script>

</body>
</html>
